from __future__ import unicode_literals
import hashlib
import datetime
import requests
import uuid

from codecs import encode

try:
    from urllib.parse import urljoin
except ImportError:
    from urlparse import urljoin

from django.conf import settings
from django.shortcuts import redirect
from .. import PaymentError, PaymentStatus, RedirectNeeded

from payments.forms import PaymentForm
from ..core import BasicProvider
from django.contrib.sites.models import Site




class BNLePOSProvider(BasicProvider):
    def __init__(self, *args, **kwargs):
        self.store_id = kwargs.pop('store_id')
        self.shared_secret = kwargs.pop('shared_secret')
        self.currency = kwargs.pop('currency', '978')
        self.endpoint = kwargs.pop('endpoint', 'https://test.ipg-online.com/connect/gateway/processing')
        super(BNLePOSProvider, self).__init__(*args, **kwargs)

    def get_hidden_fields(self):
        print(self.__dict__)
        time = datetime.datetime.now().strftime('%Y:%m:%d-%H:%M:%S')
        chargetotal = str(self.payment.total)
        hash_string = str.encode(self.store_id + time + chargetotal + self.currency + self.shared_secret)
        hash_string = encode(hash_string, 'hex')
        hash_hex = hashlib.sha1(hash_string).hexdigest()
        data = {
            'txntype': 'sale',
            'timezone': 'GMT',
            'txndatetime': time,
            'hash': hash_hex,
            'storename': self.store_id,
            'mode': 'payonly',
            'chargetotal': chargetotal,
            'oid': self.payment.token,
            'currency': self.currency,
            'language': 'en_GB',
            'responseSuccessURL': '%s' % self.get_return_url(),
            'responseFailURL': '%s' % self.get_return_url(),
        }
        return data

    def get_form(self, request=None, payment=None, data=None):
        print(data)
        print("c"*80)
        print(payment)
        print(self)
        key = "1znkzxFpeC0IXuZvaLjXD42n1k6abs4F:HPlsAMXXh1dvo9RAtkCC36Hq79opTtVt"
        data = {
                  "order_id": str(uuid.uuid4),
                  "amount": float(data["total"])
                }
        headers = {
         "Authorization": "1znkzxFpeC0IXuZvaLjXD42n1k6abs4F:rxesKLN3JqKsB5xw9k6mAAvTYSZglRGE",
         "Content-type": "application/json"
        }
        r = requests.post('https://gateway.tevi.life/api/v1/payform/token/',json = data, headers=headers)
        print(r.json()["token"])
        raise RedirectNeeded("https://gateway.tevi.life/payform?token=" + r.json()["token"] + "&key="+ key + "&redirect_uri=" + request.build_absolute_uri('/')[:-1].strip("/")+ "/process/"+ payment.token)

    def process_data(self, payment, request):
        print("se esta procesando papuuuuuuuuuuuuuu")
        print(payment.__dict__)
        if 'approval_code' in request.GET and request.GET['approval_code'].startswith('Y'):
            payment.change_status('confirmed')
            return redirect(payment.get_success_url())
        payment.change_status('rejected')
        return redirect(payment.get_failure_url())
